name: Update Adblock Rules

on:
  schedule:
    - cron: '0 0 * * 0'  # 每周更新一次
  workflow_dispatch:  # 支持手动触发

jobs:
  update_rules:
    runs-on: ubuntu-latest

    steps:
    - name: Download Adblock Domain Lists
      run: |
        LINKS=(
          "https://raw.githubusercontent.com/mullvad/dns-blocklists/main/lists/doh/adblock/AdguardDNS"
          "https://raw.githubusercontent.com/cbuijs/oisd/master/small/domains"
        )
        mkdir -p rules
        > rules/ads-domains.txt
        for LINK in "${LINKS[@]}"; do
          curl -sSL "$LINK" >> rules/ads-domains.txt
        done
        sort -u rules/ads-domains.txt -o rules/ads-domains.txt
        sed -i '/^\s*$/d' rules/ads-domains.txt

    - name: Generate Sing-box JSON Rule File
      run: |
        # 读取所有域名到一个变量并生成完整的 JSON
        domains=$(cat rules/ads-domains.txt | jq -R . | jq -s .)

        # 使用 jq 批量构建 JSON 规则文件
        jq -n --arg version "3" \
          --argjson rules "[$domains]" \
          '{"version": $version, "rules": [{"domain_suffix": $rules}]}' > rules/adblock.json

    - name: Install Sing-box
      run: |
        curl -fsSL https://sing-box.app/install.sh | sh

    - name: Compile Sing-box Rules
      run: |
        sing-box rule-set compile --output rules/adblock.srs rules/adblock.json

    - name: Commit & Push Updates
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git add rules/*
        git commit -m "Auto update Adblock rules (from GitHub Actions)"
        git push
