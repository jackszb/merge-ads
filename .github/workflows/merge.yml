name: Update AdBlock Rules

on:
  schedule:
    - cron: "0 0 * * 1"
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update_adblock_rules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl unzip
        pip install requests

    - name: Download and merge ad domains
      run: |
        echo "Downloading and merging ad domains..."
        
        DOMAIN_LISTS=(
          "https://raw.githubusercontent.com/mullvad/dns-blocklists/main/lists/doh/adblock/AdguardDNS"
          "https://raw.githubusercontent.com/cbuijs/oisd/master/small/domains"
        )
        
        > ads-domains.txt
        for url in "${DOMAIN_LISTS[@]}"; do
          curl -s "$url" | grep -v '^#' | grep -v '^$' >> ads-domains.txt
        done
        
        sort -u ads-domains.txt -o ads-domains.txt
        
        echo "ads-domains.txt generated."

    - name: Generate adblock.json
      run: |
        echo "Generating adblock.json from ads-domains.txt..."
        
        python3 - <<'EOF'
import json

with open('ads-domains.txt', 'r') as f:
    domain_list = [line.strip() for line in f.readlines() if line.strip()]

result = {
    "version": 3,
    "rules": [
        {
            "domain_suffix": domain_list
        }
    ]
}

with open('adblock.json', 'w') as json_file:
    json.dump(result, json_file, indent=2)

print("adblock.json generated.")
EOF

    - name: Install sing-box
      run: |
        echo "Installing sing-box..."
        curl -fsSL https://sing-box.app/install.sh | sh

    - name: Compile adblock.json to adblock.srs
      run: |
        echo "Compiling adblock.json to adblock.srs..."
        sing-box rule-set compile --output adblock.srs adblock.json

    - name: Commit & Push updated files
      run: |
        mkdir -p rules
        mv ads-domains.txt adblock.json adblock.srs rules/

        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

        git add rules/
        git commit -m "Auto update adblock rules" || echo "No changes"
        git push
